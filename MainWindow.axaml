<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:OplusEdlTool"
        x:Class="OplusEdlTool.MainWindow"
        Title="OPLUS EDL Tool" 
        Width="1200" Height="800"
        MinWidth="1200" MinHeight="700"
        WindowStartupLocation="CenterScreen"
        Background="#F5F5F5"
        Icon="avares://OplusEdlTool/app.ico"
        ExtendClientAreaToDecorationsHint="True"
        ExtendClientAreaChromeHints="NoChrome"
        ExtendClientAreaTitleBarHeightHint="32">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="32"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Grid Grid.Row="0" Background="#1976D2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBlock x:Name="TitleText" Grid.Column="0" Text="OPLUS EDL Tool" 
                       VerticalAlignment="Center" Margin="10,0,0,0" 
                       Foreground="White" FontWeight="SemiBold" FontSize="13"/>

            <Border Grid.Column="1" Background="Transparent" 
                    PointerPressed="TitleBar_PointerPressed"/>

            <Button x:Name="BtnLanguage" Grid.Column="2" Content="EN" 
                    Click="SwitchLanguage_Click"
                    MinWidth="120" Height="32" Padding="10,0" 
                    Background="Transparent" Foreground="White" 
                    BorderThickness="0" ToolTip.Tip="Switch Language / 切换语言" 
                    Cursor="Hand" CornerRadius="0"
                    VerticalAlignment="Center"
                    HorizontalContentAlignment="Center"
                    VerticalContentAlignment="Center">
                <Button.Styles>
                    <Style Selector="Button:pointerover">
                        <Setter Property="Background" Value="#1565C0"/>
                    </Style>
                    <Style Selector="Button:pressed">
                        <Setter Property="Background" Value="#0D47A1"/>
                    </Style>
                </Button.Styles>
            </Button>

            <Button x:Name="BtnAbout" Grid.Column="3" Content="About" 
                    Click="About_Click"
                    Width="70" Height="32" Background="Transparent" 
                    Foreground="White" BorderThickness="0" 
                    ToolTip.Tip="About this tool" Cursor="Hand" CornerRadius="0"
                    VerticalAlignment="Center"
                    HorizontalContentAlignment="Center"
                    VerticalContentAlignment="Center">
                <Button.Styles>
                    <Style Selector="Button:pointerover">
                        <Setter Property="Background" Value="#1565C0"/>
                    </Style>
                    <Style Selector="Button:pressed">
                        <Setter Property="Background" Value="#0D47A1"/>
                    </Style>
                </Button.Styles>
            </Button>

            <StackPanel Grid.Column="4" Orientation="Horizontal">
                <Button x:Name="BtnMinimize" Content="─" Click="Minimize_Click"
                        Width="46" Height="32" Background="Transparent" 
                        Foreground="White" BorderThickness="0" FontSize="10" 
                        Cursor="Hand" CornerRadius="0">
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Background" Value="#1565C0"/>
                        </Style>
                    </Button.Styles>
                </Button>
                <Button x:Name="BtnMaximize" Content="☐" Click="Maximize_Click"
                        Width="46" Height="32" Background="Transparent" 
                        Foreground="White" BorderThickness="0" FontSize="12" 
                        Cursor="Hand" CornerRadius="0">
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Background" Value="#1565C0"/>
                        </Style>
                    </Button.Styles>
                </Button>
                <Button x:Name="BtnClose" Content="✕" Click="Close_Click"
                        Width="46" Height="32" Background="Transparent" 
                        Foreground="White" BorderThickness="0" FontSize="12" 
                        Cursor="Hand" CornerRadius="0">
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Background" Value="#E81123"/>
                        </Style>
                    </Button.Styles>
                </Button>
            </StackPanel>
        </Grid>

        <Grid Grid.Row="1" Margin="4">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="28"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="280" MinWidth="250"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*" MinWidth="400"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="320" MinWidth="280"/>
            </Grid.ColumnDefinitions>

            <Grid Grid.Row="0" Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Classes="GroupBox" Margin="6">
                    <StackPanel Margin="4">
                        <TextBlock Text="Enter Firehose Mode" Classes="GroupTitle"/>
                        
                        <TextBlock x:Name="LblDevPrg" Text="Device Programmer (devprg*.mbn)" 
                                   Classes="Label"/>
                        <DockPanel Margin="0,0,0,10">
                            <Button Width="40" DockPanel.Dock="Right"
                                    Margin="8,0,0,0" Click="PickDevPrg_Click"
                                    Classes="secondary" Padding="8">
                                <PathIcon Data="M20,18H4V8H20M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6Z"/>
                            </Button>
                            <TextBox x:Name="DevPrg"/>
                        </DockPanel>
                        
                        <TextBlock x:Name="LblDigest" Text="Digest (*.bin)" 
                                   Classes="Label"/>
                        <DockPanel Margin="0,0,0,10">
                            <Button Width="40" DockPanel.Dock="Right"
                                    Margin="8,0,0,0" Click="PickDigest_Click"
                                    Classes="secondary" Padding="8">
                                <PathIcon Data="M20,18H4V8H20M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6Z"/>
                            </Button>
                            <TextBox x:Name="Digest"/>
                        </DockPanel>
                        
                        <TextBlock x:Name="LblSig" Text="Sig (*.bin)" 
                                   Classes="Label"/>
                        <DockPanel Margin="0,0,0,10">
                            <Button Width="40" DockPanel.Dock="Right"
                                    Margin="8,0,0,0" Click="PickSig_Click"
                                    Classes="secondary" Padding="8">
                                <PathIcon Data="M20,18H4V8H20M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6Z"/>
                            </Button>
                            <TextBox x:Name="Sig"/>
                        </DockPanel>
                        
                        <Button x:Name="BtnEnterFirehose" Content="Enter Firehose" 
                                HorizontalAlignment="Stretch" Margin="0,8,0,0"
                                HorizontalContentAlignment="Center"
                                Click="EnterFirehose_Click"/>
                    </StackPanel>
                </Border>

                <Border Grid.Row="1" Classes="GroupBox" Margin="6">
                    <Grid Margin="4">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Grid.Row="0" Text="Flash Package (ROM)" 
                                   Classes="GroupTitle"/>
                        
                        <TextBlock x:Name="LblSelectRom" Grid.Row="1" 
                                   Text="Select ROM folder or OFP/OPS file" 
                                   Classes="Label" TextWrapping="Wrap"/>
                        
                        <DockPanel Grid.Row="2" Margin="0,0,0,10">
                            <Button Width="40" DockPanel.Dock="Right"
                                    Margin="8,0,0,0" Click="PickRomFolder_Click"
                                    Classes="secondary" Padding="8">
                                <PathIcon Data="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z"/>
                            </Button>
                            <TextBox x:Name="RomPath" IsReadOnly="True"/>
                        </DockPanel>
                        
                        <Grid Grid.Row="3" Margin="0,4,0,4">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <ListBox x:Name="XmlFileList" Grid.Row="0" 
                                     SelectionMode="Multiple">
                                <ListBox.ItemTemplate>
                                    <DataTemplate x:DataType="local:XmlFileItem">
                                        <CheckBox Content="{Binding Name}" 
                                                  IsChecked="{Binding IsSelected, Mode=TwoWay}" 
                                                  VerticalAlignment="Center"/>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                            
                            <Grid Grid.Row="1" Margin="0,4,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="8"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="8"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <Button x:Name="BtnLoad" Grid.Column="0" Content="Load" 
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Center"
                                        Click="LoadSelectedXml_Click"
                                        ToolTip.Tip="Load partitions from selected XML files"/>
                                <Button x:Name="BtnAll" Grid.Column="2" Content="Select All" 
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Center"
                                        Click="SelectAllXml_Click" Classes="secondary"
                                        ToolTip.Tip="Select all XML files"/>
                                <Button x:Name="BtnNone" Grid.Column="4" Content="Deselect" 
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Center"
                                        Click="SelectNoneXml_Click" Classes="secondary"
                                        ToolTip.Tip="Deselect all XML files"/>
                            </Grid>
                        </Grid>
                        
                        <TextBlock Grid.Row="4" x:Name="RomInfo" Text="" 
                                   Foreground="#666" FontSize="10" TextWrapping="Wrap"/>
                    </Grid>
                </Border>
            </Grid>

            <Border Grid.Row="0" Grid.Column="1" Width="5" Background="#E0E0E0"/>

            <Border Grid.Row="0" Grid.Column="2" Classes="GroupBox" Margin="6">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <TextBlock Grid.Row="0" Text="Partitions" Classes="GroupTitle" Margin="4,4,4,4"/>
                    
                    <DockPanel Grid.Row="1" Margin="4,4,4,8">
                        <PathIcon Data="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" 
                                  VerticalAlignment="Center" Margin="0,0,8,0" Width="16" Height="16"/>
                        <TextBox x:Name="SearchBox" Watermark="Search partitions..."
                                 TextChanged="SearchBox_TextChanged"
                                 ToolTip.Tip="Search partition by name"/>
                    </DockPanel>
                    
                    <DataGrid x:Name="Grid" Grid.Row="2"
                              AutoGenerateColumns="False" 
                              CanUserReorderColumns="False"
                              CanUserResizeColumns="True"
                              CanUserSortColumns="False"
                              SelectionMode="Single" 
                              Margin="4,0,4,4"
                              IsReadOnly="True" 
                              MinHeight="200"
                              RowHeight="28"
                              Background="White"
                              Foreground="#333333"
                              GridLinesVisibility="All"
                              HeadersVisibility="Column"
                              ScrollViewer.HorizontalScrollBarVisibility="Auto"
                              ScrollViewer.VerticalScrollBarVisibility="Auto"
                              SelectionChanged="Grid_SelectionChanged"
                              DoubleTapped="Grid_DoubleTapped"
                              ToolTip.Tip="Double-click on File Path column to select a file for flashing">
                        <DataGrid.Columns>
                            <DataGridTemplateColumn Width="40">
                                <DataGridTemplateColumn.HeaderTemplate>
                                    <DataTemplate>
                                        <CheckBox x:Name="SelectAllPartitionsCheckBox" 
                                                  IsChecked="False"
                                                  HorizontalAlignment="Center"
                                                  Checked="SelectAllPartitions_Checked"
                                                  Unchecked="SelectAllPartitions_Unchecked"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.HeaderTemplate>
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate x:DataType="local:PartitionRow">
                                        <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}" 
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="Name" Binding="{Binding Name, DataType=local:PartitionRow}" Width="Auto" IsReadOnly="True"/>
                            <DataGridTextColumn Header="LUN" Binding="{Binding Lun, DataType=local:PartitionRow}" Width="Auto" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Start" Binding="{Binding FirstLBA, DataType=local:PartitionRow}" Width="Auto" IsReadOnly="True"/>
                            <DataGridTextColumn Header="End" Binding="{Binding LastLBA, DataType=local:PartitionRow}" Width="Auto" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Size" Binding="{Binding SizeFormatted, DataType=local:PartitionRow}" Width="Auto" IsReadOnly="True"/>
                            <DataGridTextColumn Header="File Path" Binding="{Binding FilePath, DataType=local:PartitionRow}" Width="Auto" IsReadOnly="True"/>
                        </DataGrid.Columns>
                    </DataGrid>
                    
                    <StackPanel Grid.Row="3" Margin="4,8,4,4">
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="6"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="6"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="6"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="6"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button x:Name="BtnReadPartitions" Grid.Column="0" Content="Read Partitions" 
                                    HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                                    Click="ReadPartitions_Click" Padding="4,6" FontSize="12"/>
                            <Button x:Name="BtnReadSelected" Grid.Column="2" Content="Read Selected" 
                                    HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                                    Click="ReadSelected_Click" Padding="4,6" FontSize="12"/>
                            <Button x:Name="BtnWriteSelected" Grid.Column="4" Content="Write Selected" 
                                    HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                                    Click="WriteSelected_Click" Padding="4,6" FontSize="12"/>
                            <Button x:Name="BtnEraseSelected" Grid.Column="6" Content="Erase Selected" 
                                    HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                                    Click="EraseSelected_Click" Padding="4,6" FontSize="12"
                                    Classes="danger"/>
                            <Button x:Name="BtnStopAll" Grid.Column="8" Content="Stop All" 
                                    HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                                    Click="StopAll_Click" Padding="4,6" FontSize="12"
                                    Classes="warning"/>
                        </Grid>
                        
                        <Button x:Name="BtnStartFlash" Content="Start Flash" 
                                HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                                Click="StartFlash_Click" Padding="8,10" FontSize="14" FontWeight="Bold"
                                Margin="0,8,0,0" Classes="success"
                                ToolTip.Tip="Auto detect device mode and start flashing all selected partitions"/>
                        
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" 
                                    Margin="0,8,0,0">
                            <CheckBox x:Name="ExportXmlCheckBox" Content="Export XML" 
                                      Margin="0,0,16,0" FontSize="12"
                                      ToolTip.Tip="Export selected partitions to rawprogram XML when backing up"/>
                            <CheckBox x:Name="ProtectLun5CheckBox" Content="Protect LUN5" x:FieldModifier="public" 
                                      Margin="0,0,16,0" FontSize="12" IsChecked="True"
                                      ToolTip.Tip="Skip flashing partitions in rawprogram5.xml to protect LUN5"/>
                            <CheckBox x:Name="AutoRebootCheckBox" Content="Auto reboot after flash" FontSize="12"
                                      ToolTip.Tip="Automatically reboot device after flashing is complete"/>
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Border>

            <Border Grid.Row="0" Grid.Column="3" Width="5" Background="#E0E0E0"/>

            <Border Grid.Row="0" Grid.Column="4" Classes="GroupBox" Margin="6">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <TextBlock x:Name="LblLog" Grid.Row="0" Text="Log" Classes="GroupTitle" Margin="4,4,4,4"/>
                    
                    <StackPanel Grid.Row="1" Margin="4,4,4,8">
                        <Border Background="#F8F9FA" CornerRadius="6" Padding="10,8" Margin="0,0,0,8">
                            <DockPanel>
                                <TextBlock x:Name="LblPort9008" Text="9008 Port:" 
                                           VerticalAlignment="Center" Margin="0,0,8,0"
                                           FontWeight="Medium"/>
                                <TextBlock x:Name="PortStatus" Text="Not detected" 
                                           VerticalAlignment="Center" Foreground="#D32F2F" 
                                           FontWeight="SemiBold"/>
                            </DockPanel>
                        </Border>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button x:Name="BtnClear" Content="Clear" 
                                    Margin="0" Click="ClearLog_Click" 
                                    Classes="secondary"
                                    HorizontalContentAlignment="Center"
                                    ToolTip.Tip="Clear log"/>
                        </StackPanel>
                    </StackPanel>
                    
                    <Border Grid.Row="2" Background="#F8F9FA" CornerRadius="6" 
                            Padding="2" Margin="4,0,4,4">
                        <TextBox x:Name="Log" IsReadOnly="True"
                                 TextWrapping="Wrap" AcceptsReturn="True"
                                 ScrollViewer.VerticalScrollBarVisibility="Auto"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                 FontFamily="{StaticResource AppFont}" FontSize="11"
                                 Background="#FAFBFC" Foreground="#24292E"
                                 Padding="10" BorderThickness="0"/>
                    </Border>
                </Grid>
            </Border>

            <ProgressBar x:Name="Progress" Grid.Row="1" Grid.ColumnSpan="5" 
                         Minimum="0" Maximum="100" Margin="8,8,8,4"/>
        </Grid>
        
    </Grid>
</Window>
